<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f3f6fa;
      margin: 0;
      padding: 0;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    .task {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 16px;
    }

    .task h3 {
      margin: 0 0 10px;
      color: #1a237e;
    }

    .task p {
      margin: 4px 0;
      color: #333;
    }

    .btn-take {
      margin-top: 10px;
      display: inline-block;
      background-color: #1a73e8;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .btn-take:hover {
      background-color: #155ab6;
    }

    .inactive-task {
      opacity: 0.5;
    }

    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #e3e9f4;
      color: #1a237e;
      padding: 6px 14px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>
  <div class="container">
    <h2>üìã –í—Å–µ –∑–∞–¥–∞–Ω–∏—è</h2>
    <div id="tasks-list">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...</p>
    </div>
  </div>

<!-- –°–ö–†–ò–ü–¢: –∑–∞–º–µ–Ω–∏—Ç—å <script> –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script>
  const airtableApiKey = 'patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4';
  const baseId = 'appTpq4tdeQ27uxQ9';
  const tableName = 'Tasks';
  const apiUrl = `https://api.airtable.com/v0/${baseId}/${tableName}`;
  const tg = window.Telegram.WebApp;
  tg.ready();

  let currentUserId = null;

  tg.getUser ? currentUserId = tg.getUser().id : tg.expand(); // fallback

const status = fields['–°—Ç–∞—Ç—É—Å'] || '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞';
      const userId = fields['ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'];

      const task = document.createElement('div');
      task.className = 'task';
      task.id = `task-${taskId}`;

      let taskContent = `
        <h3>${fields['–ü—Ä–µ–¥–º–µ—Ç'] || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'}</h3>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${fields['–û–ø–∏—Å–∞–Ω–∏–µ'] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
        <p><strong>–¶–µ–Ω–∞:</strong> ${fields['–¶–µ–Ω–∞'] || '‚Äî'}</p>
        <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> ${fields['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî'}</p>
      `;

      if (status === '–ù–æ–≤–æ–µ') {
        if (userId == user.id) {
          taskContent += `<p><em>‚ùó –í—ã –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</em></p>`;
          task.classList.add('inactive-task');
          otherTasks.push(task);
        } else if (hasActiveTask) {
          taskContent += `<p><em>‚õî –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç–µ</em></p>`;
          task.classList.add('inactive-task');
          otherTasks.push(task);
        } else {
          taskContent += `<button class="btn-take" onclick="confirmTake('${taskId}', '${fields['–ü—Ä–µ–¥–º–µ—Ç']}', '${fields['–û–ø–∏—Å–∞–Ω–∏–µ']}', '${fields['–¶–µ–Ω–∞']}', '${fields['–î–µ–¥–ª–∞–π–Ω']}')">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
          task.innerHTML = taskContent;
          newTasks.push(task);
        }
      } else {
        taskContent += `<p><em>–°—Ç–∞—Ç—É—Å: ${status}</em></p>`;
        task.classList.add('inactive-task');
        task.innerHTML = taskContent;
        otherTasks.push(task);
      }
    });

    [...newTasks, ...otherTasks].forEach(task => document.getElementById('tasks-list').appendChild(task));

  } catch (error) {
    document.getElementById('tasks-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π üò•</p>';
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞–Ω–∏–π:', error);
    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞–Ω–∏–π: " + error.message);
  }
}

  async function confirmTake(taskId, subject, description, price, deadline) {
    const confirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É?");
    if (!confirmed) return;

    try {
      const updateUrl = `${apiUrl}/${taskId}`;
      const updateData = {
        fields: {
          "–°—Ç–∞—Ç—É—Å": "–í —Ä–∞–±–æ—Ç–µ",
          "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è": tg.initDataUnsafe.user.id,
          "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram": tg.initDataUnsafe.user.username || "–±–µ–∑ username"
        }
      };

      const response = await fetch(updateUrl, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      });

      if (response.ok) {
        const taskElement = document.getElementById(`task-${taskId}`);
        if (taskElement) taskElement.remove();

        const message = `
‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–∑—è–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É!
üìö –ü—Ä–µ–¥–º–µ—Ç: ${subject}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${description}
üí∞ –û–ø–ª–∞—Ç–∞: ${price} ‚ÇΩ
‚è∞ –î–µ–¥–ª–∞–π–Ω: ${deadline}

‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –≤ —Å—Ä–æ–∫ ‚Äî –∏–Ω–∞—á–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.
üí∏ –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–µ–∏–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ –¥–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã.
        `;
        alert(message);
        tg.close();
      } else {
        const errorText = await response.text();
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", errorText);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ: " + errorText);
      }

    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ confirmTake:", error);
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è: " + error.message);
    }
  }

  fetchTasks();
</script>
</body>
</html>
