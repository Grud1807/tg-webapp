<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f3f6fa;
      margin: 0;
      padding: 0;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    .task {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 16px;
    }

    .task h3 {
      margin: 0 0 10px;
      color: #1a237e;
    }

    .task p {
      margin: 4px 0;
      color: #333;
    }

    .btn-take {
      margin-top: 10px;
      background-color: #1a73e8;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-take:hover {
      background-color: #155ab6;
    }

    .inactive-task {
      opacity: 0.5;
    }

    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #e3e9f4;
      color: #1a237e;
      padding: 6px 14px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>
  <div class="container">
    <h2>üìã –í—Å–µ –∑–∞–¥–∞–Ω–∏—è</h2>
    <div id="tasks-list">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...</p>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    const user = tg.initDataUnsafe.user || {};
    const userId = user.id || 0; // –µ—Å–ª–∏ –Ω–µ—Ç id ‚Äî —Å—Ç–∞–≤–∏–º 0
    const userUsername = user.username ? `@${user.username}` : "–±–µ–∑ username";

    const apiUrl = "https://api.airtable.com/v0/appTpq4tdeQ27uxQ9/Tasks";
    const airtableApiKey = "patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4";
    const takeTaskUrl = "https://studentus-server.onrender.com/take-task"; // üîÅ –ø–æ–¥—Å—Ç–∞–≤—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É

    async function fetchTasks() {
      try {
        const response = await fetch(apiUrl, {
          headers: { Authorization: Bearer ${airtableApiKey} }
        });

        const data = await response.json();
        const tasksContainer = document.getElementById('tasks-list');
        tasksContainer.innerHTML = '';

        const newTasks = [];
        const otherTasks = [];
        let hasActiveTask = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —É —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
        data.records.forEach(record => {
          const status = record.fields['–°—Ç–∞—Ç—É—Å'];
          const executorId = record.fields['ID –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è'];
          if (status === '–í —Ä–∞–±–æ—Ç–µ' && executorId == userId) {
            hasActiveTask = true;
          }
        });

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫
        data.records.forEach(record => {
          const taskId = record.id;
          const fields = record.fields;
          const status = fields['–°—Ç–∞—Ç—É—Å'] || '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞';
          const ownerId = fields['ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'];
          const customerUsername = fields['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram'] || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";

          const task = document.createElement('div');
          task.className = 'task';
          task.id = task-${taskId};

          let content = `
            <h3>${fields['–ü—Ä–µ–¥–º–µ—Ç'] || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'}</h3>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${fields['–û–ø–∏—Å–∞–Ω–∏–µ'] || '‚Äî'}</p>
            <p><strong>–¶–µ–Ω–∞:</strong> ${fields['–¶–µ–Ω–∞'] || '‚Äî'} ‚ÇΩ</p>
            <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> ${fields['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî'}</p>
          `;

          if (status === '–ù–æ–≤–æ–µ') {
            if (ownerId == userId) {
              content += `<p><em>‚ùóÔ∏è –í—ã –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</em></p>`;
              task.classList.add('inactive-task');
              task.innerHTML = content;
              otherTasks.push(task);
            } else if (hasActiveTask) {content += `<p><em>‚õîÔ∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</em></p>`;
              task.classList.add('inactive-task');
              task.innerHTML = content;
              otherTasks.push(task);
            } else {
              content += `<button class="btn-take" onclick="takeTask('${taskId}', '${customerUsername}', '${fields['–ü—Ä–µ–¥–º–µ—Ç']}', '${fields['–û–ø–∏—Å–∞–Ω–∏–µ']}', '${fields['–¶–µ–Ω–∞']}', '${fields['–î–µ–¥–ª–∞–π–Ω']}')">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
              task.innerHTML = content;
              newTasks.push(task);
            }
          } else {
            content += `<p><em>–°—Ç–∞—Ç—É—Å: ${status}</em></p>`;
            task.classList.add('inactive-task');
            task.innerHTML = content;
            otherTasks.push(task);
          }
        });

        [...newTasks, ...otherTasks].forEach(t => tasksContainer.appendChild(t));
      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        document.getElementById('tasks-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π üò•</p>';
      }
    }

    async function takeTask(taskId, customerUsername, subject, description, price, deadline) {
      const confirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É?");
      if (!confirmed) return;

      try {
        const res = await fetch(takeTaskUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            record_id: taskId,
            executor_id: userId,
            executor_username: userUsername
          })
        });

        const result = await res.json();

        if (result.success) {
          alert(`‚úÖ –í—ã –≤–∑—è–ª–∏ –∑–∞–¥–∞–Ω–∏–µ!\n\nüìö ${subject}\nüìù ${description}\nüí∞ ${price} ‚ÇΩ\n‚è∞ ${deadline}\n\n–ö–æ–Ω—Ç–∞–∫—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞: ${customerUsername}`);
          const taskEl = document.getElementById(`task-${taskId}`);
          if (taskEl) taskEl.remove();
          tg.close();
        } else {
          alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ: " + result.error);
          console.error("–û—à–∏–±–∫–∞:", result.error);
        }
      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
      }
    }

    fetchTasks();
  </script>
</body>
</html>
