<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Список заданий</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .task {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .task h3 {
            margin: 0 0 10px 0;
            color: #34495e;
        }
        .task p {
            margin: 5px 0;
            color: #555;
        }
        .take-btn {
            display: inline-block;
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .take-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        #back {
            position: fixed;
            top: 15px;
            left: 15px;
            background: #2980b9;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <a id="back" href="index.html">← Назад на главную</a>
    <h1>Список заданий</h1>
    <div id="tasks"></div>

    <script>
        const AIRTABLE_API_KEY = "patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4";
        const AIRTABLE_BASE_ID = "appTpq4tdeQ27uxQ9";
        const AIRTABLE_TABLE_NAME = "Tasks";
        const AIRTABLE_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;

        let tg = window.Telegram.WebApp;
        let user = tg.initDataUnsafe?.user;

        async function fetchTasks() {
            try {
                const response = await fetch(AIRTABLE_URL, {
                    headers: { Authorization: "Bearer " + AIRTABLE_API_KEY }
                });
                const data = await response.json();

                const tasksDiv = document.getElementById("tasks");
                tasksDiv.innerHTML = "";

                data.records.forEach(record => {
                    const status = record.fields["Статус"] || "";
                    const executorId = record.fields["ID исполнителя"];

                    const taskDiv = document.createElement("div");
                    taskDiv.className = "task";

                    taskDiv.innerHTML = `
                        <h3>${record.fields["Предмет"] || "Без предмета"}</h3>
                        <p><strong>Описание:</strong> ${record.fields["Описание"] || "—"}</p>
                        <p><strong>Цена:</strong> ${record.fields["Цена"] || "—"}</p>
                        <p><strong>Дедлайн:</strong> ${record.fields["Дедлайн"] || "—"}</p>
                        <p><strong>Статус:</strong> ${status}</p>
                    `;

                    const btn = document.createElement("button");
                    btn.className = "take-btn";
                    btn.textContent = "Взять в работу";

                    // Кнопка доступна только если задание "Новое"
                    if (status === "Новое") {
                        btn.onclick = () => takeTask(record.id);
                    } else {
                        btn.disabled = true;
                    }

                    taskDiv.appendChild(btn);
                    tasksDiv.appendChild(taskDiv);
                });
            } catch (error) {
                console.error("Ошибка загрузки:", error);
                alert("Ошибка загрузки заданий!");
            }
        }

        async function takeTask(recordId) {
            if (!user) {
                alert("Ошибка: не удалось определить пользователя Telegram.");
                return;
            }

            try {
                await fetch(`${AIRTABLE_URL}/${recordId}`, {
                    method: "PATCH",
                    headers: {
                        Authorization: "Bearer " + AIRTABLE_API_KEY,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        fields: {
                            "Статус": "В работе",
                            "ID исполнителя": user.id
                        }
                    })
                });

                alert("Задание успешно взято в работу!");
                fetchTasks();
            } catch (error) {
                console.error("Ошибка при взятии задания:", error);
                alert("Не удалось взять задание.");
            }
        }

        fetchTasks();
    </script>
</body>
</html>