<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <a href="index.html" class="back">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <h2>üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</h2>
    <div id="tasks"></div>
  </div>

  <script>
    const AIRTABLE_API_KEY = "patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4";
    const BASE_ID = "appTpq4tdeQ27uxQ9";
    const TABLE_NAME = "Tasks";
    const AIRTABLE_URL = https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME};

    async function loadTasks() {
      const response = await fetch(`${AIRTABLE_URL}?filterByFormula=%7B–°—Ç–∞—Ç—É—Å%7D%3D%22–ù–æ–≤–∞—è%22`, {
        headers: {
          Authorization: Bearer ${AIRTABLE_API_KEY}
        }
      });
      const data = await response.json();

      const container = document.getElementById("tasks");
      if (data.records.length === 0) {
        container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π üòå</p>";
        return;
      }

      data.records.forEach((record) => {
        const task = record.fields;
        const div = document.createElement("div");
        div.className = "task-card";
        div.innerHTML = `
          <h3>${task["–ü—Ä–µ–¥–º–µ—Ç"] || "–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞"}</h3>
          <p>${task["–û–ø–∏—Å–∞–Ω–∏–µ"] || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
          <p>üí∞ ${task["–¶–µ–Ω–∞"]  0} ‚ÇΩ &nbsp; ‚è∞ ${task["–î–µ–¥–ª–∞–π–Ω"]  "-"}</p>
          <button onclick="takeTask('${record.id}')">üë®‚Äçüîß –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
        `;
        container.appendChild(div);
      });
    }

    async function takeTask(taskId) {
      const userId = Telegram.WebApp.initDataUnsafe?.user?.id || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      const response = await fetch(`${AIRTABLE_URL}/${taskId}`, {
        method: "PATCH",
        headers: {
          Authorization: Bearer ${AIRTABLE_API_KEY},
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            "–°—Ç–∞—Ç—É—Å": "–í —Ä–∞–±–æ—Ç–µ",
            "ID –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è": String(userId)
          }
        })
      });

      if (response.ok) {
        alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É!");
        window.location.reload();
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
      }
    }

    loadTasks();
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
