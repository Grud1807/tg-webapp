<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f3f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .task {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 16px;
    }
    .task h3 {
      margin: 0 0 10px;
      color: #1a237e;
    }
    .task p {
      margin: 4px 0;
      color: #333;
    }
    .btn-take {
      margin-top: 10px;
      display: inline-block;
      background-color: #1a73e8;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .btn-take:hover {
      background-color: #155ab6;
    }
    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #e3e9f4;
      color: #1a237e;
      padding: 6px 14px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-button">–ù–∞–∑–∞–¥</a>
  <div class="container">
    <h2>üìã –í—Å–µ –∑–∞–¥–∞–Ω–∏—è</h2>
    <div id="tasks-list">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...</p>
    </div>
  </div>

  <script>
    const airtableApiKey = "patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4";
    const baseId = "appTpq4tdeQ27uxQ9";
    const tableName = "Tasks";
    const apiUrl = `https://api.airtable.com/v0/${baseId}/${tableName}`;
    const botToken = "8101750587:AAEoO1Aote7wHIRDADD4kpwFyYOYIkibe_c";

    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id;

    async function fetchTasks() {
      const response = await fetch(`${apiUrl}?filterByFormula=AND(Status='–ù–æ–≤–æ–µ')`, {
        headers: { Authorization:` Bearer ${airtableApiKey}` }
      });
      const data = await response.json();
      const tasksContainer = document.getElementById('tasks-list');
      tasksContainer.innerHTML = '';

      if (!data.records || data.records.length === 0) {
        tasksContainer.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.</p>';
        return;
      }

      data.records.forEach(record => {
        const taskId = record.id;
        const fields = record.fields;

        const task = document.createElement('div');
        task.className = 'task';
        task.id = `task-${taskId}`;
        task.innerHTML = `
          <h3>${fields['–ü—Ä–µ–¥–º–µ—Ç'] || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'}</h3>
          <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${fields['–û–ø–∏—Å–∞–Ω–∏–µ'] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
          <p><strong>–¶–µ–Ω–∞:</strong> ${fields['–¶–µ–Ω–∞'] || '‚Äî'}</p>
          <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> ${fields['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî'}</p>
          <button class="btn-take" onclick="confirmTake('${taskId}', '${fields['ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'] || ''}', '${fields['–ü—Ä–µ–¥–º–µ—Ç']}', '${fields['–û–ø–∏—Å–∞–Ω–∏–µ']}', '${fields['–¶–µ–Ω–∞']}', '${fields['–î–µ–¥–ª–∞–π–Ω']}')">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
        `;
        tasksContainer.appendChild(task);
      });
    }

    async function confirmTake(taskId, ownerId, subject, description, price, deadline) {
      const confirmAction = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É?");
      if (!confirmAction) return;

      // 1. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è –≤ Airtable
      await fetch(`${apiUrl}/${taskId}`, {
        method: "PATCH",
        headers: {
          Authorization:` Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            "–°—Ç–∞—Ç—É—Å": "–í —Ä–∞–±–æ—Ç–µ"
          }
        })
      });

      // 2. –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const taskElement = document.getElementById(`task-${taskId}`);
      if (taskElement) taskElement.remove();

      // 3. –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º WebApp
      tg.close();
      // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é —Å –¥–µ—Ç–∞–ª—è–º–∏
      const instruction =` –í—ã —É—Å–ø–µ—à–Ω–æ –≤–∑—è–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É!\n\nüìö –ü—Ä–µ–¥–º–µ—Ç: ${subject}\nüìù –û–ø–∏—Å–∞–Ω–∏–µ: ${description}\nüí∞ –¶–µ–Ω–∞: ${price}\n‚è∞ –î–µ–¥–ª–∞–π–Ω: ${deadline}\n\n‚ùóÔ∏è–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –≤ —Å—Ä–æ–∫. –í —Å–ª—É—á–∞–µ –Ω–µ–∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.\nüí∏ –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã.\n\n–î–ª—è —Å–≤—è–∑–∏ —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º: https://t.me/${ownerId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
      await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          chat_id: userId,
          text: instruction
        })
      });
    }

    fetchTasks();
  </script>
</body>
</html>
