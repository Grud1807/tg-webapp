<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f3f6fa;
      margin: 0;
      padding: 0;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    .task {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 16px;
    }

    .task h3 {
      margin: 0 0 10px;
      color: #1a237e;
    }

    .task p {
      margin: 4px 0;
      color: #333;
    }

    .btn-take {
      margin-top: 10px;
      display: inline-block;
      background-color: #1a73e8;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .btn-take:hover {
      background-color: #155ab6;
    }

    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #e3e9f4;
      color: #1a237e;
      padding: 6px 14px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }

    .filter {
      margin-bottom: 20px;
    }

    .filter select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-button">–ù–∞–∑–∞–¥</a>
  <div class="container">
    <h2>üìã –í—Å–µ –∑–∞–¥–∞–Ω–∏—è</h2>

    <div class="filter">
      <label for="subjectFilter">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: </label>
      <select id="subjectFilter" onchange="fetchTasks()">
        <option value="">–í—Å–µ</option>
        <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
        <option value="–§–∏–∑–∏–∫–∞">–§–∏–∑–∏–∫–∞</option>
        <option value="–•–∏–º–∏—è">–•–∏–º–∏—è</option>
        <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
        <!-- –î–æ–±–∞–≤—å —Å–≤–æ–∏ -->
      </select>
    </div>

    <div id="tasks-list" class="loading">
      –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...
    </div>
  </div>

  <script>
    const airtableApiKey = 'patZ7hX8W8F8apmJm.9adf2ed71f8925dd372af08a5b5af2af4b12ead4abc0036be4ea68c43c47a8c4';
    const baseId = 'appTpq4tdeQ27uxQ9';
    const tableName = 'Tasks';
    const apiUrl = `https://api.airtable.com/v0/${baseId}/${tableName}`;
    const tg = window.Telegram.WebApp;
    tg.expand();

    async function fetchTasks() {
      const subjectFilter = document.getElementById("subjectFilter").value;
      let filterFormula = `AND({–°—Ç–∞—Ç—É—Å} = '–ù–æ–≤–æ–µ')`;

      if (subjectFilter) {
        filterFormula = `AND({–°—Ç–∞—Ç—É—Å} = '–ù–æ–≤–æ–µ', {–ü—Ä–µ–¥–º–µ—Ç} = '${subjectFilter}')`;
      }

      const url =`${apiUrl}?filterByFormula=${encodeURIComponent(filterFormula)}`;

      try {
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${airtableApiKey}`
          }
        });

        const data = await response.json();
        const tasksContainer = document.getElementById('tasks-list');
        tasksContainer.innerHTML = '';

        if (!data.records || data.records.length === 0) {
          tasksContainer.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.</p>';
          return;
        }

        data.records.forEach(record => {
          const task = document.createElement('div');
          task.className = 'task';

          const taskId = record.id;

          task.innerHTML = `
            <h3>${record.fields['–ü—Ä–µ–¥–º–µ—Ç'] || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'}</h3>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${record.fields['–û–ø–∏—Å–∞–Ω–∏–µ'] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
            <p><strong>–¶–µ–Ω–∞:</strong> ${record.fields['–¶–µ–Ω–∞'] || '‚Äî'}</p>
            <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> ${record.fields['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî'}</p>
            <button class="btn-take" onclick="confirmTake('${taskId}', this)">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
          `;

          tasksContainer.appendChild(task);
        });

      } catch (error) {document.getElementById('tasks-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π üò•</p>';
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞–Ω–∏–π:', error);
      }
    }

    async function confirmTake(recordId, button) {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É?")) return;

      button.innerText = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";
      button.disabled = true;

      try {
        const patchUrl = ${apiUrl}/${recordId};
        const payload = {
          fields: {
            "–°—Ç–∞—Ç—É—Å": "–í —Ä–∞–±–æ—Ç–µ",
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram": tg.initDataUnsafe.user?.username || "–Ω–µ—Ç username",
            "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è": tg.initDataUnsafe.user?.id
          }
        };

        const res = await fetch(patchUrl, {
          method: "PATCH",
          headers: {
            Authorization: Bearer ${airtableApiKey},
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          alert("üéâ –ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤–∑—è—Ç–æ!");
          button.parentElement.remove(); // —É–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞–Ω–∏—è
        } else {
          alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏:", err);
        alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.");
      }
    }

    fetchTasks();
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
